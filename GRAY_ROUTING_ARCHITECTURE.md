# 灰度路由架构设计

## 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              灰度发布系统架构                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │   Client    │───▶│   Gateway   │───▶│  Consumer   │───▶│  Provider   │      │
│  │   客户端     │    │    网关      │    │   消费者     │    │   提供者     │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                │                               │
│                                                ▼                               │
│                                        ┌─────────────┐                         │
│                                        │  RocketMQ   │                         │
│                                        │   消息队列   │                         │
│                                        └─────────────┘                         │
│                                                │                               │
│                                                ▼                               │
│                                        ┌─────────────┐                         │
│                                        │  Provider   │                         │
│                                        │ MQ Consumer │                         │
│                                        │  消息消费者  │                         │
│                                        └─────────────┘                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## HTTP请求灰度路由泳道图

```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│   Client    │   Gateway   │  Consumer   │  Provider   │    Nacos    │
│    客户端    │    网关      │   消费者     │   提供者     │  注册中心    │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│             │             │             │             │             │
│ 1. 发送请求  │             │             │             │             │
│ Header:     │             │             │             │             │
│ gray=feat1  │             │             │             │             │
│ ────────────┼────────────▶│             │             │             │
│             │             │             │             │             │
│             │ 2. 解析灰度  │             │             │             │
│             │ 标识        │             │             │             │
│             │ ────────────┼────────────▶│             │             │
│             │             │             │             │             │
│             │             │ 3. 查询服务  │             │             │
│             │             │ 实例列表     │             │             │
│             │             │ ────────────┼────────────▶│             │
│             │             │             │             │ ────────────┼────────────▶│
│             │             │             │             │ 4. 返回实例  │
│             │             │             │             │ (含metadata) │
│             │             │ ◀───────────┼─────────────│             │
│             │             │             │             │             │
│             │             │ 5. 过滤匹配  │             │             │
│             │             │ 版本的实例   │             │             │
│             │             │ (feat1)     │             │             │
│             │             │ ────────────┼────────────▶│             │
│             │             │             │             │             │
│             │             │             │ 6. 处理请求  │             │
│             │             │             │ 返回feat1   │             │
│             │             │             │ 版本数据     │             │
│             │             │ ◀───────────┼─────────────│             │
│             │             │             │             │             │
│             │ ◀───────────┼─────────────│             │             │
│             │             │             │             │             │
│ ◀───────────┼─────────────│             │             │             │
│             │             │             │             │             │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

## RocketMQ消息灰度路由泳道图

```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│  Consumer   │  RocketMQ   │ Provider-N  │Provider-F1  │Provider-F2  │
│   消费者     │   消息队列   │ (Normal)    │(Gray-Feat1) │(Gray-Feat2) │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│             │             │             │             │             │
│ 1. 发送消息  │             │             │             │             │
│ Tag=feat1   │             │             │             │             │
│ ────────────┼────────────▶│             │             │             │
│             │             │             │             │             │
│             │ 2. 存储消息  │             │             │             │
│             │ 按Tag分类   │             │             │             │
│             │             │             │             │             │
│             │ 3. 推送消息  │             │             │             │
│             │ (Tag=normal)│             │             │             │
│             │ ────────────┼────────────▶│             │             │
│             │             │ 4. 消费消息  │             │             │
│             │             │ (忽略)      │             │             │
│             │             │             │             │             │
│             │ 5. 推送消息  │             │             │             │
│             │ (Tag=feat1) │             │             │             │
│             │ ────────────┼─────────────┼────────────▶│             │
│             │             │             │ 6. 消费消息  │             │
│             │             │             │ (处理)      │             │
│             │             │             │             │             │
│             │ 7. 推送消息  │             │             │             │
│             │ (Tag=feat2) │             │             │             │
│             │ ────────────┼─────────────┼─────────────┼────────────▶│
│             │             │             │             │ 8. 消费消息  │
│             │             │             │             │ (忽略)      │
│             │             │             │             │             │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

## 灰度标识传递流程图

### HTTP请求链路传递

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            HTTP请求灰度标识传递链路                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Client Request                                                                 │
│  ┌─────────────────┐                                                           │
│  │ HTTP Headers:   │                                                           │
│  │ gray: feat1     │                                                           │
│  └─────────────────┘                                                           │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │    Gateway      │───▶│   Consumer      │───▶│   Provider      │            │
│  │                 │    │                 │    │                 │            │
│  │ 1. 解析Header   │    │ 3. 接收Header   │    │ 5. 接收Header   │            │
│  │ 2. 路由选择     │    │ 4. 传递Header   │    │ 6. 版本处理     │            │
│  │    feat1版本    │    │    (Feign)      │    │    feat1逻辑    │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│           │                       │                       │                    │
│           ▼                       ▼                       ▼                    │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │ GrayRouting     │    │ GrayContext     │    │ Business Logic  │            │
│  │ Filter          │    │ ThreadLocal     │    │ Version-based   │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### RocketMQ消息传递

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          RocketMQ消息灰度标识传递链路                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Consumer Service                                                               │
│  ┌─────────────────┐                                                           │
│  │ 1. 获取灰度标识  │                                                           │
│  │ gray = feat1    │                                                           │
│  │ 2. 设置消息Tag  │                                                           │
│  │ tag = feat1     │                                                           │
│  └─────────────────┘                                                           │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐                                                           │
│  │   RocketMQ      │                                                           │
│  │   ┌─────────┐   │                                                           │
│  │   │Topic:   │   │                                                           │
│  │   │gray-topic│   │                                                           │
│  │   │         │   │                                                           │
│  │   │Tag:feat1│   │                                                           │
│  │   └─────────┘   │                                                           │
│  └─────────────────┘                                                           │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┬─────────────────┬─────────────────┐                      │
│  │ Provider-Normal │Provider-Feat1   │Provider-Feat2   │                      │
│  │                 │                 │                 │                      │
│  │ ConsumerGroup:  │ConsumerGroup:   │ConsumerGroup:   │                      │
│  │ provider-normal │provider-feat1   │provider-feat2   │                      │
│  │                 │                 │                 │                      │
│  │ Selector:       │Selector:        │Selector:        │                      │
│  │ tag=normal      │tag=feat1        │tag=feat2        │                      │
│  │                 │                 │                 │                      │
│  │ ❌ 不消费        │ ✅ 消费处理      │ ❌ 不消费        │                      │
│  └─────────────────┴─────────────────┴─────────────────┘                      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 版本隔离架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              版本隔离架构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                            ┌─────────────┐                                     │
│                            │   Client    │                                     │
│                            │   客户端     │                                     │
│                            └──────┬──────┘                                     │
│                                   │                                            │
│                                   ▼                                            │
│                            ┌─────────────┐                                     │
│                            │   Gateway   │                                     │
│                            │    网关      │                                     │
│                            └──────┬──────┘                                     │
│                                   │                                            │
│                    ┌──────────────┼──────────────┐                            │
│                    │              │              │                            │
│                    ▼              ▼              ▼                            │
│            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                    │
│            │ Consumer-N  │ │Consumer-F1  │ │Consumer-F2  │                    │
│            │ (Normal)    │ │(Gray-Feat1) │ │(Gray-Feat2) │                    │
│            │ Port: 8081  │ │Port: 8083   │ │Port: 8084   │                    │
│            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                    │
│                   │               │               │                            │
│                   ▼               ▼               ▼                            │
│            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                    │
│            │ Provider-N  │ │Provider-F1  │ │Provider-F2  │                    │
│            │ (Normal)    │ │(Gray-Feat1) │ │(Gray-Feat2) │                    │
│            │ Port: 8082  │ │Port: 8085   │ │Port: 8086   │                    │
│            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                    │
│                   │               │               │                            │
│                   └───────────────┼───────────────┘                            │
│                                   │                                            │
│                                   ▼                                            │
│                            ┌─────────────┐                                     │
│                            │  RocketMQ   │                                     │
│                            │             │                                     │
│                            │ ┌─────────┐ │                                     │
│                            │ │Topic:   │ │                                     │
│                            │ │gray-topic│ │                                     │
│                            │ │         │ │                                     │
│                            │ │Tags:    │ │                                     │
│                            │ │normal   │ │                                     │
│                            │ │feat1    │ │                                     │
│                            │ │feat2    │ │                                     │
│                            │ └─────────┘ │                                     │
│                            └─────────────┘                                     │
│                                   │                                            │
│                    ┌──────────────┼──────────────┐                            │
│                    │              │              │                            │
│                    ▼              ▼              ▼                            │
│            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                    │
│            │MQ Consumer-N│ │MQ Consumer-F1│ │MQ Consumer-F2│                    │
│            │Group:       │ │Group:        │ │Group:        │                    │
│            │provider-    │ │provider-     │ │provider-     │                    │
│            │normal       │ │feat1         │ │feat2         │                    │
│            │             │ │              │ │              │                    │
│            │Selector:    │ │Selector:     │ │Selector:     │                    │
│            │tag=normal   │ │tag=feat1     │ │tag=feat2     │                    │
│            └─────────────┘ └─────────────┘ └─────────────┘                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 灰度路由决策流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            灰度路由决策流程                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                              ┌─────────────┐                                   │
│                              │ 接收请求     │                                   │
│                              │ (HTTP/MQ)   │                                   │
│                              └──────┬──────┘                                   │
│                                     │                                          │
│                                     ▼                                          │
│                              ┌─────────────┐                                   │
│                              │ 提取灰度标识 │                                   │
│                              │ gray=?      │                                   │
│                              └──────┬──────┘                                   │
│                                     │                                          │
│                                     ▼                                          │
│                              ┌─────────────┐                                   │
│                              │ 灰度标识     │                                   │
│                              │ 是否为空?    │                                   │
│                              └──────┬──────┘                                   │
│                                     │                                          │
│                        ┌────────────┼────────────┐                            │
│                        │ 是          │           │ 否                         │
│                        ▼            ▼           ▼                            │
│                ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│                │ 路由到       │ │ 查找灰度     │ │ 查找灰度     │                │
│                │ Normal版本   │ │ 版本实例     │ │ 版本实例     │                │
│                └─────────────┘ └──────┬──────┘ └──────┬──────┘                │
│                                       │               │                        │
│                                       ▼               ▼                        │
│                                ┌─────────────┐ ┌─────────────┐                │
│                                │ 灰度版本     │ │ 灰度版本     │                │
│                                │ 实例存在?    │ │ 实例可用?    │                │
│                                └──────┬──────┘ └──────┬──────┘                │
│                                       │               │                        │
│                            ┌──────────┼───────┐       │                        │
│                            │ 是        │      │ 否    │                        │
│                            ▼          ▼      ▼       ▼                        │
│                    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│                    │ 路由到       │ │ 降级到       │ │ 健康检查     │            │
│                    │ 灰度版本     │ │ Normal版本   │ │ 失败处理     │            │
│                    └─────────────┘ └─────────────┘ └─────────────┘            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 技术实现关键点

### 1. HTTP请求路由关键组件

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          HTTP路由技术实现                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Gateway层                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ GrayRoutingFilter                                                       │   │
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │   │
│  │ │ 1. 解析Header   │ │ 2. 查询实例     │ │ 3. 过滤匹配     │           │   │
│  │ │ gray=feat1      │ │ 从Nacos获取     │ │ metadata匹配    │           │   │
│  │ └─────────────────┘ └─────────────────┘ └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Consumer层                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ GrayLoadBalancerConfig                                                  │   │
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │   │
│  │ │ 1. 接收请求     │ │ 2. 上下文管理   │ │ 3. Feign传递    │           │   │
│  │ │ 提取灰度标识    │ │ ThreadLocal     │ │ Header传递      │           │   │
│  │ └─────────────────┘ └─────────────────┘ └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2. RocketMQ消息路由关键组件

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        RocketMQ路由技术实现                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Producer端 (Consumer服务)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ ConsumerService                                                         │   │
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │   │
│  │ │ 1. 获取灰度标识 │ │ 2. 构建消息     │ │ 3. 发送消息     │           │   │
│  │ │ 从上下文获取    │ │ 设置Tag=feat1   │ │ 到RocketMQ      │           │   │
│  │ └─────────────────┘ └─────────────────┘ └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Consumer端 (Provider服务)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ GrayMessageConsumer                                                     │   │
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │   │
│  │ │ 1. 消费者组     │ │ 2. Tag选择器    │ │ 3. 消息处理     │           │   │
│  │ │ provider-feat1  │ │ tag=feat1       │ │ 版本化业务逻辑  │           │   │
│  │ └─────────────────┘ └─────────────────┘ └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

这些架构图清晰地展示了灰度路由在HTTP请求和RocketMQ消息中的传递机制，帮助理解整个灰度发布系统的工作原理。
